<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>VibifyEnv</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />

    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"
      integrity="sha512-dqw6X88iGgZlTsONxZK9ePmJEFrmHwpuMrsUChjAw1mRUhUITE5QU9pkcSox+ynfLhL15Sv2al5A0LVyDCmtUw=="
      crossorigin="anonymous"
    ></script>
    <script>
      let audioFeatures = {
        rms: 0,
        loudness: 1,
        energy: 0,
        spectralCentroid: 0,
        chroma: [],
        bpm: 0,
        scale: 0,
        beatSwitch: false,
      };
      let scene;
      let arrayOfSmallObject = [];
    </script>
  </head>
  <body>
    <main id="main">
      <div class="audio-container">
        <div id="file-select-area">
          <div id="file-drop-area">
            <span>Drop file here or click to upload</span>
          </div>
        </div>
        <audio id="audioTag" controls autoplay>aa</audio>
        <div class="features">
          <div class="features-div">
            <h2>Affect Estimation <br />(Essentia)</h2>
            <h3 id="sadTag">Sad:<br /></h3>
            <h3 id="relaxTag">Relax:<br /></h3>
            <h3 id="happyTag">Happy:<br /></h3>
            <h3 id="aggressiveTag">Agressive:<br /></h3>
            <h3 id="danceTag">Dance:<br /></h3>
          </div>
          <div class="features-div">
            <h2>Lables <br />(Essentia)</h2>
            <h3 id="bpmTag">Bpm:<br /></h3>
            <h3 id="keyTag">Key:<br /></h3>
            <h3 id="scaleTag">Scale:<br /></h3>
          </div>
          <div class="features-div">
            <h2>Real Time Extraction <br />(Meyda)</h2>
            <h3 id="loudnessTag">Loudness:<br /></h3>
            <h3 id="energyTag">Energy:<br /></h3>
            <h3 id="rmsTag">RMS:<br /></h3>
            <h3 id="spectralCentroidTag">Spectral Centroid:<br /></h3>
            <h3 id="chromaTag">Chroma:<br /></h3>
          </div>
        </div>
      </div>

      <div id="beatContainer">BEAT</div>
      <canvas id="myCanvasId"></canvas>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/essentia.js@0.1.0/dist/essentia-wasm.web.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/essentia.js@0.1.0/dist/essentia.js-core.js"></script>

    <script
      type="text/javascript"
      src="https://unpkg.com/meyda@5.5.1/dist/web/meyda.min.js"
    ></script>

    <script type="module">
      import * as THREE from "./modules/three.module.js";
      import { OrbitControls } from "./modules/OrbitControls.js";
      import { addSmallCube } from "./geometry.js";

      

      scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );

      const renderer = new THREE.WebGLRenderer({
        /* alpha: true, */
        /* antialias: true,
         */
        canvas: myCanvasId,
      });
      renderer.setClearColor(0x323232);
      renderer.setSize(window.innerWidth * 0.7, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap

      const light = new THREE.AmbientLight(0xffffff, 0.05);

      scene.add(light);

      const pointLight = new THREE.PointLight(0xff00ff, 2, 17);
      pointLight.position.set(-5, 5, 5);
      pointLight.castShadow = true;

      scene.add(pointLight);

      const sphereSize = 1;
      const pointLightHelper = new THREE.PointLightHelper(
        pointLight,
        sphereSize
      );

      const pointLight2 = new THREE.PointLight(0x00ffff, 2, 17);
      pointLight2.position.set(5, 5, 5);
      pointLight2.castShadow = true;

      scene.add(pointLight2);

      const pointLightHelper2 = new THREE.PointLightHelper(
        pointLight2,
        sphereSize
      );

      const pointLight3 = new THREE.PointLight(0xffffff, 0.2, 1000);
      pointLight3.position.set(0, 0, 10);
      pointLight3.castShadow = true;
      /*   scene.add(pointLight3); */

      const pointLightHelper3 = new THREE.PointLightHelper(pointLight3, 2);

      scene.add(pointLightHelper);
      scene.add(pointLightHelper2);
      scene.add(pointLightHelper3);

      function removeEntity(object) {
        var selectedObject = scene.getObjectByName(object.name);
        scene.remove(selectedObject);
      }

      const geometry = new THREE.BoxGeometry(1, 1, 1);

      const material = new THREE.MeshLambertMaterial({ color: 0xffffff });
      const cube = new THREE.Mesh(geometry, material);
      cube.castShadow = true;
      cube.rotation.x = 0.8;
      cube.rotation.y = 0.8;
      scene.add(cube);
      camera.position.z = 5;

      const control = new OrbitControls(camera, renderer.domElement);
      /*      const helper = new THREE.CameraHelper( pointLight2.shadow.camera );
scene.add( helper ); */
      var geo = new THREE.PlaneBufferGeometry(10, 10, 8, 8);
      var mat = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        side: THREE.DoubleSide,
      });

      var plane = new THREE.Mesh(geo, mat);
      plane.rotation.x = 3.1415 / 2;
      plane.position.y = -3;
      scene.add(plane);
      plane.receiveShadow = true;

      let chromaArrayBalls = [];
      function chromaBallsSpawn() {
        for (let index = 0; index < 12; index++) {
          const sphereGeometr = new THREE.SphereGeometry(0.3, 15, 15);
          const sphere = new THREE.Mesh(sphereGeometr, material);
          sphere.position.x = -6 + index;
          sphere.position.y = 3;
          sphere.position.z = -5;
          scene.add(sphere);
          chromaArrayBalls.push(sphere);
        }
      }
      chromaBallsSpawn();

      function animate() {
        requestAnimationFrame(animate);

        control.update();
        if (audioFeatures.chroma.length > 0) {
          chromaArrayBalls.forEach((ball, index) => {
            ball.position.y = audioFeatures.chroma[index] + 3;

            ball.scale.x = audioFeatures.chroma[index];
            ball.scale.y = audioFeatures.chroma[index];
            ball.scale.z = audioFeatures.chroma[index];
          });
        }

        /*  arrayOfSmallObject.forEach((object) => {
       
          object.position.y -= 0.03;
          object.scale.x = (audioFeatures["loudness"] / 200) * 3;
          object.scale.y = (audioFeatures["loudness"] / 200) * 3;
          object.scale.z = (audioFeatures["loudness"] / 200) * 3;
          if (object.position.y < -3) {
            scene.remove(object);
          }
        }); */
        if (audioFeatures.beatSwitch) {
          cube.rotation.x += audioFeatures.rms / 5;
          cube.rotation.y += audioFeatures.energy / 160;
        } else {
          cube.rotation.x -= audioFeatures.rms / 5;
          cube.rotation.y -= audioFeatures.energy / 160;
        }

        cube.scale.x = 1 + (audioFeatures["loudness"] / 100) * 3;
        cube.scale.y = 1 + (audioFeatures["loudness"] / 100) * 3;
        cube.scale.z = 1 + (audioFeatures["loudness"] / 100) * 3;
        renderer.render(scene, camera);
        
      }

      animate();
    </script>
    <script src="src/main.js" type="module" async defer></script>
  </body>
</html>
